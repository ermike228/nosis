name: NOSIS API CI/CD Pipeline

# Этот workflow запускается на push в main, develop, и на pull requests.
on:
  push:
    branches:
      - "main"
      - "develop"
  pull_request:
    branches:
      - "main"
      - "develop"

# Переменные окружения на уровне workflow
env:
  PYTHON_VERSION: "3.11"
  PROJECT_NAME: "nosis"
  DOCKER_IMAGE: "nosis/api"
  REGISTRY: "ghcr.io/${{ github.repository }}"
  CACHE_BUCKET: "nosis-ci-cache"
  TF_CACHE: ${{ github.workspace }}/.cache/tf

jobs:
  ########################################################
  # JOB 1 — LINT / STATIC ANALYSIS / AI QUALITY CHECK
  ########################################################
  lint_and_analyze:
    name: Linting & AI Static Analysis
    runs-on: ubuntu-latest
    outputs:
      lint-result: ${{ steps.lint.outputs.result }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dev Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.base.txt
          pip install -r requirements.dev.txt

      - name: Run Ruff (Fast Lint)
        id: lint
        run: |
          ruff .
          echo "::set-output name=result::success"

      - name: Run Mypy (Static Type Check)
        run: |
          mypy .

      - name: Run AI Quality Annotator
        uses: github/codeql-action/analyze@v3
        with:
          category: "security-and-quality"
          languages: "python"
          scan-mode: "quick"

      - name: Upload Lint Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: lint-results
          path: .
          retention-days: 7

  ########################################################
  # JOB 2 — UNIT TESTS + SMOKE TESTS + BENCHMARKS
  ########################################################
  test_and_bench:
    name: Tests & Benchmarks
    needs: lint_and_analyze
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.base.txt
          pip install -r requirements.dev.txt

      - name: Run Pytest (Unit & Integration)
        run: |
          pytest --disable-warnings --maxfail=1 --cov=core --cov=services

      - name: Benchmark Models (Smoke)
        run: |
          # Запустить минимальные генерирующие тесты для ключевых моделей
          python -m scripts.smoke_test

      - name: Collect Test Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: ./reports

  ########################################################
  # JOB 3 — BUILD & PUSH DOCKER IMAGE
  ########################################################
  build_and_publish:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest
    needs: test_and_bench
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: GitHub Container Registry Login
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker Image
        uses: docker/build-push-action@v3
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }}:latest
            ${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }}:${{ github.sha }}

  ########################################################
  # JOB 4 — DEPLOY TO STAGING
  ########################################################
  deploy_staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: build_and_publish
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" > kubeconfig
          kubectl config use-context staging

      - name: Deploy via Helm
        run: |
          helm upgrade --install nosis-api ./deploy/helm \
            --namespace staging \
            --set image.repository=${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ github.sha }}

  ########################################################
  # JOB 5 — DEPLOY TO PRODUCTION (MANUAL)
  ########################################################
  deploy_prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build_and_publish
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ secrets.PROD_URL }}
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" > kubeconfig
          kubectl config use-context production

      - name: Deploy via Helm
        run: |
          helm upgrade --install nosis-api ./deploy/helm \
            --namespace default \
            --set image.repository=${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ github.sha }}
