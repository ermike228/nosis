name: NOSIS ML Training Pipeline

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Model name to train (music | voice | bark | hybrid)"
        required: true
        default: "voice"
      dataset_version:
        description: "Dataset version or tag"
        required: true
        default: "v1"
      training_stage:
        description: "Stage (pretrain | finetune | full)"
        required: true
        default: "finetune"
      epochs:
        description: "Training epochs"
        required: true
        default: "10"

  push:
    paths:
      - "core/**"
      - "services/**"
      - "training/**"
      - "requirements/**"

env:
  PYTHON_VERSION: "3.11"
  PROJECT_NAME: "nosis"
  WANDB_PROJECT: "nosis-training"
  MLFLOW_TRACKING_URI: "file:./mlruns"
  HF_HOME: ${{ github.workspace }}/.cache/huggingface
  TORCH_HOME: ${{ github.workspace }}/.cache/torch
  DATA_ROOT: "./data"
  MODEL_ROOT: "./models"
  TRAIN_LOGS: "./training_logs"

jobs:
  #########################################################
  # JOB 1 — DATA & CONFIG VALIDATION
  #########################################################
  validate:
    name: Validate datasets & configs
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install base dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.base.txt
          pip install -r requirements/requirements.dev.txt

      - name: Validate dataset integrity
        run: |
          python scripts/prepare_datasets.py \
            --dataset ${{ inputs.dataset_version }} \
            --check-integrity

      - name: Validate training configs
        run: |
          python -m core.config.validate \
            --stage ${{ inputs.training_stage }}

  #########################################################
  # JOB 2 — TRAINING (GPU / DISTRIBUTED READY)
  #########################################################
  train:
    name: Train model
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 720

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache ML assets
        uses: actions/cache@v4
        with:
          path: |
            .cache/huggingface
            .cache/torch
            data/cache
          key: ml-cache-${{ hashFiles('requirements/**', 'training/**') }}

      - name: Install training dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements/requirements.base.txt
          pip install -r requirements/requirements.train.txt

      - name: Login to Weights & Biases
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        run: |
          wandb login $WANDB_API_KEY

      - name: Launch training
        env:
          CUDA_VISIBLE_DEVICES: "0"
        run: |
          python training/train.py \
            --model ${{ inputs.model_name }} \
            --dataset ${{ inputs.dataset_version }} \
            --stage ${{ inputs.training_stage }} \
            --epochs ${{ inputs.epochs }} \
            --output-dir ${{ env.MODEL_ROOT }} \
            --log-dir ${{ env.TRAIN_LOGS }} \
            --use-wandb \
            --use-mlflow

      - name: Save checkpoints
        uses: actions/upload-artifact@v4
        with:
          name: model-checkpoints
          path: models/checkpoints
          retention-days: 30

  #########################################################
  # JOB 3 — AUTOMATED QUALITY EVALUATION
  #########################################################
  evaluate:
    name: Evaluate model quality
    needs: train
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install evaluation dependencies
        run: |
          pip install -r requirements/requirements.base.txt
          pip install -r requirements/requirements.dev.txt

      - name: Run objective metrics (FAD / MOS / Similarity)
        run: |
          python evaluation/run_metrics.py \
            --model-dir models/checkpoints \
            --dataset ${{ inputs.dataset_version }}

      - name: Upload evaluation report
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-report
          path: evaluation/reports

  #########################################################
  # JOB 4 — MODEL REGISTRATION & EXPORT
  #########################################################
  register:
    name: Register & export model
    needs: evaluate
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install export dependencies
        run: |
          pip install -r requirements/requirements.base.txt
          pip install onnx onnxruntime

      - name: Export model to ONNX
        run: |
          python training/export_onnx.py \
            --checkpoint models/checkpoints \
            --output models/onnx

      - name: Register model in MLflow
        run: |
          python training/register_model.py \
            --model-path models/onnx \
            --stage staging

  #########################################################
  # JOB 5 — QUALITY GATE (BLOCKER)
  #########################################################
  quality_gate:
    name: Quality gate
    needs: register
    runs-on: ubuntu-latest

    steps:
      - name: Enforce quality thresholds
        run: |
          python evaluation/quality_gate.py \
            --min-mos 4.2 \
            --max-fad 1.5
